#!/bin/sh

THIS_MAX_RETRIES=3
wait_for_success() {
    local retry=0

    # if less than 5 times
    while [ $retry -lt $THIS_MAX_RETRIES ]; do
        # gets the current volume from pipewire
        wpctl get-volume @DEFAULT_SOURCE@
        # if successful, will return right after
        if [ $? -eq 0 ]; then
            return 0
        fi

        # if not, waits for a second and tries again
        sleep 1
        retry=$(expr $retry + 1)
    done

    # if retried 5 times, finish unsuccessfully
    return 1
}

THIS_MAX_RESTARTS=2
main() {
    local restart=0

    # if less than 3 times
    while [ $restart -lt $THIS_MAX_RESTARTS ]; do
        # restarts pipewire, or creates it if not created
        gentoo-pipewire-launcher restart &
        # wait with the above function to connect to pipewire
        wait_for_success
        # if successful, will return right after
        if [ $? -eq 0 ]; then
            break
        fi

        # if not, waits for a second and tries again
        restart=$(expr $restart + 1)
    done
}

# run loop
main
